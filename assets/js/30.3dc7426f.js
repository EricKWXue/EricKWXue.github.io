(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{356:function(s,a,t){"use strict";t.r(a);var n=t(0),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"postgresql高可用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#postgresql高可用"}},[s._v("#")]),s._v(" PostgreSQL高可用")]),s._v(" "),t("ul",[t("li",[s._v("yum安装前\n"),t("ul",[t("li",[s._v("yum search java | grep -i --color jdk")]),s._v(" "),t("li",[s._v("yum install -y java-1.8.0-openjdk-devel.x86_64")])])]),s._v(" "),t("li",[s._v("yum卸载前\n"),t("ul",[t("li",[s._v("yum list installed | grep 'java|jdk|gcj|jre'")]),s._v(" "),t("li",[s._v("yum -y remove java-1.8.0-openjdk-devel.x86_64")])])])]),s._v(" "),t("h2",{attrs:{id:"一-安装步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-安装步骤"}},[s._v("#")]),s._v(" 一. 安装步骤")]),s._v(" "),t("ul",[t("li",[s._v("联网环境下，yum源安装（以CentOS8为例）")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Install the repository RPM:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" dnf "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Disable the built-in PostgreSQL module:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" dnf -qy module disable postgresql\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Install PostgreSQL:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" dnf "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y postgresql17-server\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Optionally initialize the database and enable automatic start:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" /usr/pgsql-17/bin/postgresql-17-setup initdb\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" postgresql-17\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl start postgresql-17\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("ul",[t("li",[s._v("未联网下，yum源安装（以CentOS8为例）")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Install the repository RPM:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" dnf "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载到postgresql17目录，然后打包导出，再导入到新server")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" dnf "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" --downloadonly --downloaddir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./postgresql17 postgresql17-server\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" dnf "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" --downloadonly --downloaddir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./postgresql17 pgvector_17\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" dnf "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" --downloadonly --downloaddir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./postgresql17 repmgr_17\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#打包")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("zip")]),s._v(" -r postgresql17.zip postgresql17\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#解包")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("unzip")]),s._v(" postgresql17.zip\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装已经下载好的")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" dnf "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" ./postgresql17/*.rpm\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Optionally initialize the database and enable automatic start:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" /usr/pgsql-17/bin/postgresql-17-setup initdb\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" postgresql-17\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl start postgresql-17\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("ul",[t("li",[s._v("未联网下，rpm手动安装（以CentOS8为例）")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载合适的版本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https://yum.postgresql.org/rpmchart/")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以15为例，页面四个包全部下载（下载依赖包）：https://yum.postgresql.org/15/redhat/rhel-7-x86_64/repoview/postgresqldbserver15.group.html")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最终如下：")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# libzstd-1.5.5-1.el7.x86_64.rpm")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lz4-1.8.3-1.el7.x86_64.rpm")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# postgresql15-libs-15.5-1PGDG.rhel7.x86_64.rpm")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# postgresql15-15.5-1PGDG.rhel7.x86_64.rpm")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# postgresql15-server-15.5-1PGDG.rhel7.x86_64.rpm")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 依次安装")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -i *\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("h2",{attrs:{id:"二-创建用户和db"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-创建用户和db"}},[s._v("#")]),s._v(" 二. 创建用户和DB")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换到postgres")]),s._v("\nsu "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" postgres\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 打开pgsql 如果有特殊端口 加上-p")]),s._v("\npsql\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行sql，修改密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" postgres "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" password "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'XXX123zyx'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建用户和DB, 先不建schema，用默认的public即可")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" xue "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" password "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xue#0126'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("database")]),s._v(" xue owner xue"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("grant")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("all")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("privileges")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("database")]),s._v(" xue "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" xue"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建只读账号")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" xue_rd "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" PASSWORD "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xue#012602'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" xue_rd "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" default_transaction_read_only"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CONNECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DATABASE")]),s._v(" xue "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" xue_rd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\\c xue\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USAGE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SCHEMA")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" xue_rd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SCHEMA")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" xue_rd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIVILEGES")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SCHEMA")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" xue_rd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建扩展")]),s._v("\n\\c xue\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" EXTENSION vector"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 退出")]),s._v("\n\\q\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再退出")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("exit")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br")])]),t("h2",{attrs:{id:"三-修改配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三-修改配置文件"}},[s._v("#")]),s._v(" 三. 修改配置文件")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 把listen_addresses改为‘*'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 把port改为54321")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 调优：")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# DB Version: 17; OS Type: linux; DB Type: web; Total Memory (RAM): 16 GB; CPUs num: 8; Data Storage: hdd")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_connections = 200")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# shared_buffers = 4GB #系统内存的25%")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# effective_cache_size = 8GB #系统内存的50%")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# maintenance_work_mem = 512MB #配置为512MB")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# checkpoint_completion_target = 0.9 #用于控制数据多久刷新写盘，默认0.9")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wal_buffers = 16MB #默认是shared_buffers的值除以32，这边直接设置成16MB")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# default_statistics_target = 100 # 默认100")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# random_page_cost = 4 #默认4.0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# effective_io_concurrency = 1 #默认1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# work_mem = 4MB， 推荐4M-16M")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# huge_pages = off #默认try")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# min_wal_size = 1GB # 用于控制pg里面的wal日志最大占用多大磁盘空间")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_wal_size = 4GB # 用于控制pg里面的wal日志最大占用多大磁盘空间")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_worker_processes = 8 #并发查询数量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_parallel_workers_per_gather = 2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_parallel_workers = 8")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_parallel_maintenance_workers = 2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /var/lib/pgsql/17/data/postgresql.conf \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加：host all all all scram-sha-256")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# IPv4 local connections:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# host    all             all             127.0.0.1/32            scram-sha-256")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# host    xue             xue_rd          10.0.0.0/8              scram-sha-256")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# host    xue             xue             192.168.211.0/24        scram-sha-256")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /var/lib/pgsql/17/data/pg_hba.conf\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启")]),s._v("\nsystemctl restart postgresql-17\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br")])]),t("h3",{attrs:{id:"_3-1-修改数据存储路径"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-修改数据存储路径"}},[s._v("#")]),s._v(" 3.1 修改数据存储路径")]),s._v(" "),t("p",[s._v("确认原始数据存储路径")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres\npsql -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54321")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("postgres")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SHOW data_directory;")]),s._v("\n     data_directory     \n------------------------\n /var/lib/pgsql/17/data\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" row"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("关停pgsql")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("systemctl stop postgresql-17\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("迁移数据")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /data/pgsql/17/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R postgres:postgres /data/pgsql/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 把原来的数据路径data拷贝到/17下")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -a /var/lib/pgsql/17/data/ /data/pgsql/17/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("修改存储路径")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("systemctl edit postgresql-17\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 写入")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Environment")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("PGDATA"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/data/pgsql/17/data/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#实际路径：/etc/systemd/system/postgresql-17.service.d/override.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动")]),s._v("\nsystemctl daemon-reload\nsystemctl start postgresql-17\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h3",{attrs:{id:"_3-2-定期备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-定期备份"}},[s._v("#")]),s._v(" 3.2 定期备份")]),s._v(" "),t("p",[s._v("开启备份配置：archive_command和restore_command的最佳实践")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /data/pgsql/17/backup/pg_wal_archive\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_wal_senders = 10")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_replication_slots = 10")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wal_level = 'replica'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wal_log_hints = on")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# hot_standby = on")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# archive_mode = on")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# archive_command = 'test ! -f /data/pgsql/17/backup/pg_wal_archive/%f && cp %p /data/pgsql/17/backup/pg_wal_archive/%f'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# restore_command = 'cp /data/pgsql/17/backup/pg_wal_archive/%f %p'   # 恢复数据时，从哪里拷贝归档文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /data/pgsql/17/data/postgresql.conf \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h4",{attrs:{id:"_3-2-1-逻辑备份与恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-逻辑备份与恢复"}},[s._v("#")]),s._v(" 3.2.1 逻辑备份与恢复")]),s._v(" "),t("ul",[t("li",[s._v("逻辑备份")])]),s._v(" "),t("p",[t("code",[s._v("/usr/pgsql-17/bin/pg_dump")]),s._v("或者"),t("code",[s._v("/usr/pgsql-17/bin/pg_dump/pg_dumpall")]),s._v("，导出数据到XXX.sql")]),s._v(" "),t("p",[s._v("支持增量备份")]),s._v(" "),t("ul",[t("li",[s._v("逻辑恢复")])]),s._v(" "),t("p",[t("code",[s._v("/usr/pgsql-17/bin/pg_restore")])]),s._v(" "),t("p",[s._v("缺点：数据量大的时候，恢复太慢了，暂时不采用。")]),s._v(" "),t("h4",{attrs:{id:"_3-2-2-物理备份与恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-物理备份与恢复"}},[s._v("#")]),s._v(" 3.2.2 物理备份与恢复")]),s._v(" "),t("p",[s._v("全量备份")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("/usr/pgsql-17/bin/pg_basebackup -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54321")]),s._v(" -U repmgr -Ft -X stream -z -D /data/pgsql/17/backup/pg_backup/"),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +%Y-%m-%d-FULL"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" -v\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("备注：repmgr账号在"),t("strong",[s._v("4.1 主节点配置")]),s._v("中因为已经配置好了，所以这边偷懒了直接拿来用。")]),s._v(" "),t("p",[s._v("全量恢复")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份下现有数据")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" /data/pgsql/17/data/ /data/pgsql/17/data.bak/\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将基础备份解压到数据目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /data/pgsql/17/data/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" 0700 /data/pgsql/17/data/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf /data/pgsql/17/backup/pg_backup/2025-01-23-FULL/base.tar.gz -C /data/pgsql/17/data/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf /data/pgsql/17/backup/pg_backup/2025-01-23-FULL/pg_wal.tar.gz -C /data/pgsql/17/backup/pg_wal_archive/\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建recovery.signal文件和standby.signal文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" /data/pgsql/17/data/recovery.signal\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" /data/pgsql/17/data/standby.signal\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动恢复数据库")]),s._v("\nsystemctl start postgresql-17\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除recovery.signal文件（如果需要读写，也要删除standby.signal文件），重启")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf /data/pgsql/17/data/recovery.signal\nsystemctl restart postgresql-17\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("ul",[t("li",[s._v("新方案：增量备份")])]),s._v(" "),t("p",[s._v("采用17.2最新特性：开启WAL summarizer增量备份")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /data/pgsql/17/data/postgresql.conf \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# summarize_wal = on")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wal_summary_keep_time = '10d'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("基于全量备份，做增量备份")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("/usr/pgsql-17/bin/pg_basebackup -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54321")]),s._v(" -U repmgr -Ft -X stream -z -D /data/pgsql/17/backup/pg_backup/"),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +%Y-%m-%d-INCR"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" -v -i /data/pgsql/17/backup/pg_backup/2025-01-23-FULL/backup_manifest\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("全量+增量恢复")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 解压全量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf /data/pgsql/17/backup/pg_backup/2025-01-23-FULL/base.tar.gz -C /data/pgsql/17/backup/pg_backup/2025-01-23-FULL-READY/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf /data/pgsql/17/backup/pg_backup/2025-01-23-FULL/pg_wal.tar.gz -C /data/pgsql/17/backup/pg_backup/2025-01-23-FULL-READY/pg_wal/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /data/pgsql/17/backup/pg_backup/2025-01-23-FULL/backup_manifest /data/pgsql/17/backup/pg_backup/2025-01-23-FULL-READY/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 解压增量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf /data/pgsql/17/backup/pg_backup/2025-01-23-INCR/base.tar.gz -C /data/pgsql/17/backup/pg_backup/2025-01-23-INCR-READY/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf /data/pgsql/17/backup/pg_backup/2025-01-23-INCR/pg_wal.tar.gz -C /data/pgsql/17/backup/pg_backup/2025-01-23-INCR-READY/pg_wal/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /data/pgsql/17/backup/pg_backup/2025-01-23-INCR/backup_manifest /data/pgsql/17/backup/pg_backup/2025-01-23-INCR-READY/\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#合并全量和增量")]),s._v("\n/usr/pgsql-17/bin/pg_combinebackup "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2025")]),s._v("-01-23-FULL-READY "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2025")]),s._v("-01-23-INCR-READY -o "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2025")]),s._v("-01-23-RESTORE-FULL\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份下现有数据")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" /data/pgsql/17/data/ /data/pgsql/17/data.bak/\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#执行恢复数据库")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" /data/pgsql/17/backup/pg_backup/2025-01-23-RESTORE-FULL/ /data/pgsql/17/data/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" /data/pgsql/17/data/standby.signal\nsystemctl start postgresql-17\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("h4",{attrs:{id:"_3-2-3-备份脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-备份脚本"}},[s._v("#")]),s._v(" 3.2.3 备份脚本")]),s._v(" "),t("p",[s._v("定时物理备份脚本：采用每周六全备 + 每周日~周五增量备份的策略，有效备份保留1个月")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /data/pgsql/17/backup/bin\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份脚本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /data/pgsql/17/backup/bin/backup.sh\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x /data/pgsql/17/backup/bin/backup.sh\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#PostgreSQL env settings")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("BAK_BASE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data/pgsql/17/backup/pg_backup"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2023-05-02")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DATE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +%F"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2023-05-01")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("YESTERDAY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +%F -d "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-1 days"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 0代表周日，6代表周六")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WEEK_DAY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +%w"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("BAK_DIR")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BAK_BASE")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DATE")]),s._v("-"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$WEEK_DAY")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("START_TIME")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"+%Y-%m-%d %H:%M:%S"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"############## Physical backup start at '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$START_TIME")]),s._v(' ##############"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$WEEK_DAY")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6"')]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n\t\t/usr/pgsql-17/bin/pg_basebackup -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54321")]),s._v(" -U repmgr -Ft -X stream -z -D "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BAK_DIR")]),s._v(" -v\n        "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"FULL"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("elif")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$WEEK_DAY")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("INCRE_BASE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BAK_BASE")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$YESTERDAY")]),s._v("-6\n        /usr/pgsql-17/bin/pg_basebackup -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54321")]),s._v(" -U repmgr -Ft -X stream -z -D "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BAK_DIR")]),s._v(" -v -i "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$INCRE_BASE")]),s._v("/backup_manifest\n        "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"INCR"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("INCRE_BASE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BAK_BASE")]),s._v("/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$YESTERDAY")]),s._v("-$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WEEK_DAY-1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        /usr/pgsql-17/bin/pg_basebackup -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54321")]),s._v(" -U repmgr -Ft -X stream -z -D "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BAK_DIR")]),s._v(" -v -i "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$INCRE_BASE")]),s._v("/backup_manifest\n        "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"INCR"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("END_TIME")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"+%Y-%m-%d %H:%M:%S"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"############## Physical backup end at '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$END_TIME")]),s._v(' ##############"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SIZE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("du")]),s._v(" -sh $BAK_DIR "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v(" -eq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Backup completed successfully."')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Backup is available at: '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BAK_DIR")]),s._v('/backup_label"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"|------------------------------------------|--------|---------------------|---------------------|------------|'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"| %-40s | %-6s | %-19s | %-19s | %-10s |'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Label"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Type"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Start Timestamp"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Stop Timestamp"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Size"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"|------------------------------------------|--------|---------------------|---------------------|------------|'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"| %-40s | %-6s | %-19s | %-19s | %-10s |'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$BAK_DIR")]),s._v('/backup_label"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$TYPE")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$START_TIME")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$END_TIME")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$SIZE")]),s._v('"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"|------------------------------------------|--------|---------------------|---------------------|------------|'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Backup failed."')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 清理脚本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v("  /data/pgsql/17/backup/bin/cleanup.sh\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x /data/pgsql/17/backup/bin/cleanup.sh\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("START_TIME")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"+%Y-%m-%d %H:%M:%S"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"############## clean up start at '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$START_TIME")]),s._v(' ##############"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" /data/pgsql/17/backup/pg_backup -maxdepth "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" -type d -mtime +30\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" /data/pgsql/17/backup/pg_backup -maxdepth "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" -type d -mtime +30 -exec "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("END_TIME")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"+%Y-%m-%d %H:%M:%S"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"############## clean up end at '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$END_TIME")]),s._v(' ##############"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br"),t("span",{staticClass:"line-number"},[s._v("75")]),t("br"),t("span",{staticClass:"line-number"},[s._v("76")]),t("br")])]),t("p",[s._v("设置定时器")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("crontab")]),s._v(" -l \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" * * * /data/pgsql/17/backup/bin/backup.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /data/pgsql/17/backup/bin/backup.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" \n00 08 * * "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" /data/pgsql/17/backup/bin/cleanup.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /data/pgsql/17/backup/bin/cleanup.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"四-主从复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四-主从复制"}},[s._v("#")]),s._v(" 四. 主从复制")]),s._v(" "),t("p",[s._v("采用repmgr，文档：https://www.repmgr.org/docs/5.5/installation-packages.html#INSTALLATION-PACKAGES-REDHAT")]),s._v(" "),t("p",[s._v("主节点（192.168.211.1）支持增删改查，从节点（192.168.211.2）只支持查询！")]),s._v(" "),t("h3",{attrs:{id:"_4-0-前置作业"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-0-前置作业"}},[s._v("#")]),s._v(" 4.0 前置作业")]),s._v(" "),t("h4",{attrs:{id:"_4-0-1-ssh免密登录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-0-1-ssh免密登录"}},[s._v("#")]),s._v(" 4.0.1 ssh免密登录")]),s._v(" "),t("p",[s._v("允许所有账号免密登录")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/ssh/sshd_config\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# PubkeyAuthentication no")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#重启sshd服务")]),s._v("\nsystemctl restart sshd\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("或者：允许固定账号的ssh免密登录")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/ssh/sshd_config\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# PubkeyAuthentication no")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Match Address <固定IP> User <账号> PubkeyAuthentication yes")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("两台机器分别生成公私钥，并执行拷贝。实现postgres这个账号的互相ssh免密访问")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres\nssh-keygen -t rsa\nssh-copy-id -i ~/.ssh/id_rsa.pub "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".211.1\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh-copy-id -i ~/.ssh/id_rsa.pub 192.168.211.2")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h4",{attrs:{id:"_4-0-2-pg-rewind开启"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-0-2-pg-rewind开启"}},[s._v("#")]),s._v(" 4.0.2 pg_rewind开启")]),s._v(" "),t("p",[s._v("使用pg_rewind需要打开配置wal_log_hints=on，full_page_writes=on。在pgsql-17.2版本中默认开启的。")]),s._v(" "),t("p",[s._v("pg_rewind同步数据主要依赖wal日志，位于$PGDATA/pg_wal目录中，因为打开了archive_mode=on，如果没有配置archive_command，日志会越来越大。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# $PGDATA=/data/pgsql/17/data/")]),s._v("\n/usr/pgsql-17/bin/pg_controldata "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PGDATA")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Latest checkpoint's REDO WAL file:    00000001000000010000000E")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#表示00000001000000010000000E之前的pg_wal文件可以删除，执行删除")]),s._v("\n/usr/pgsql-17/bin/pg_archivecleanup -d "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PGDATA")]),s._v("/pg_wal 00000001000000010000000E \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h4",{attrs:{id:"_4-0-3-keepalived开启"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-0-3-keepalived开启"}},[s._v("#")]),s._v(" 4.0.3 keepalived开启")]),s._v(" "),t("p",[s._v("两台机器都得安装，把主节点配置成master节点。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\ndnf "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" keepalived\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/keepalived/keepalived.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ! Configuration File for keepalived")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vrrp_instance VI_1 {")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     state BACKUP")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     interface eth0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     virtual_router_id 25")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     priority 100 #master配置为100，backup配置为90")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     advert_int 1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     authentication {")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#         auth_type PASS")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#         auth_pass 852963741")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     }")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     unicast_src_ip 192.168.211.1 #当前机器")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     unicast_peer {")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#         192.168.211.2  #对方机器")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     }")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     virtual_ipaddress {")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#         192.168.211.3 #虚拟ip")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     }")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# }")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动")]),s._v("\nsystemctl start keepalived\nsystemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" keepalived\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("h3",{attrs:{id:"_4-1-主节点配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-主节点配置"}},[s._v("#")]),s._v(" 4.1 主节点配置")]),s._v(" "),t("p",[s._v("开启备份日志")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /data/pgsql/17/backup/pg_wal_archive\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_wal_senders = 10")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_replication_slots = 10")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wal_level = 'replica'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wal_log_hints = on")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# hot_standby = on")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# archive_mode = on")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# archive_command = 'test ! -f /data/pgsql/17/backup/pg_wal_archive/%f && cp %p /data/pgsql/17/backup/pg_wal_archive/%f'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# restore_command = 'cp /data/pgsql/17/backup/pg_wal_archive/%f %p'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /data/pgsql/17/data/postgresql.conf \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("创建用于备份的用户")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建repmgrDB与用户")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres\ncreateuser -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54321")]),s._v(" -s repmgr\ncreatedb -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54321")]),s._v(" repmgr -O repmgr\npsql -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54321")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("postgres")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# ALTER USER repmgr SET search_path TO repmgr, "$user", public;')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("postgres")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# \\q")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("主从节点相互信任")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    local   replication   repmgr                              trust")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    host    replication   repmgr      127.0.0.1/32            trust")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    host    replication   repmgr      192.168.211.1/32      trust")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    host    replication   repmgr      192.168.211.2/32      trust")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    local   repmgr        repmgr                              trust")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    host    repmgr        repmgr      127.0.0.1/32            trust")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    host    repmgr        repmgr      192.168.211.1/32      trust")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    host    repmgr        repmgr      192.168.211.2/32      trust")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /data/pgsql/17/data/pg_hba.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("配置repmgr")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# node_id=1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# node_name='node1'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# conninfo='host=192.168.211.1 port=54321 user=repmgr dbname=repmgr connect_timeout=2'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# data_directory='/data/pgsql/17/data'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/repmgr/17/repmgr.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("注册主机点")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -f /etc/repmgr/17/repmgr.conf primary register"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看状态")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr service status"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"_4-2-从节点配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-从节点配置"}},[s._v("#")]),s._v(" 4.2 从节点配置")]),s._v(" "),t("p",[s._v("测试能否访问主节点")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"psql 'host=192.168.211.1 port=54321 user=repmgr dbname=repmgr connect_timeout=2'\"")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("创建归档目录")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /data/pgsql/17/backup/pg_wal_archive\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("配置repmgr")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# node_id=2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# node_name='node2'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# conninfo='host=192.168.211.2 port=54321 user=repmgr dbname=repmgr connect_timeout=2'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# data_directory='/data/pgsql/17/data'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/repmgr/17/repmgr.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("拷贝主节点配置文件")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试主节点是否能通")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -h 192.168.211.1 -p 54321 -U repmgr -d repmgr -f /etc/repmgr/17/repmgr.conf standby clone --dry-run"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行拷贝")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -h 192.168.211.1 -p 54321 -U repmgr -d repmgr -f /etc/repmgr/17/repmgr.conf standby clone"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" postgresql-17\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl start postgresql-17\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("连接主节点查询备份机情况")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("psql -U repmgr -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54321")]),s._v(" -h "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".211.1 -d repmgr\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("repmgr")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SELECT * FROM pg_stat_replication;")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("注册从节点")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -f /etc/repmgr/17/repmgr.conf standby register"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看集群状态")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -f /etc/repmgr/17/repmgr.conf cluster show"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"_4-3-主动切换"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-主动切换"}},[s._v("#")]),s._v(" 4.3 主动切换")]),s._v(" "),t("p",[s._v("暂不设定故障自动切换，容易出现脑裂情况。手动切换比较安全！")]),s._v(" "),t("h4",{attrs:{id:"_4-3-1-启用备用节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-1-启用备用节点"}},[s._v("#")]),s._v(" 4.3.1 启用备用节点")]),s._v(" "),t("p",[s._v("当主节点（node1）挂掉后，手动切换从节点（node2）为主节点")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将备用机（node2）提升为主节点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -f /etc/repmgr/17/repmgr.conf standby promote"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("keepalived优先级调高")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将备用机（node2）的keepalived优先级调高")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/keepalived/keepalived.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     priority 110")]),s._v("\nsystemctl restart keepalived\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h4",{attrs:{id:"_4-3-2-恢复旧主节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-2-恢复旧主节点"}},[s._v("#")]),s._v(" 4.3.2 恢复旧主节点")]),s._v(" "),t("p",[s._v("修复好主节点（node1）后，让主节点（node1）重新变为主节点。以下操作全在node1上执行：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1.关停node1服务")]),s._v("\nsystemctl stop postgresql-17\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2.重新加入集群, 成为从节点。如果失败 就只能执行2.1、2.2、2.3、2.4进行全拷贝了")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"/usr/pgsql-17/bin/repmgr -f /etc/repmgr/17/repmgr.conf node rejoin -d 'host=192.168.211.2 port=54321 user=repmgr dbname=repmgr' --force-rewind\"")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2.1 测试拷贝从节点（node2）的数据到主节点（node1）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -h 192.168.211.2 -p 54321 -U repmgr -d repmgr -f /etc/repmgr/17/repmgr.conf standby clone --dry-run"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2.2 执行拷贝")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -h 192.168.211.2 -p 54321 -U repmgr -d repmgr -f /etc/repmgr/17/repmgr.conf standby clone --force"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2.3 开启node1")]),s._v("\nsystemctl start postgresql-17\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2.4 把node1先重新注册为从节点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -f /etc/repmgr/17/repmgr.conf standby register --force"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3.最后一步：主从交换(需要两台机器ssh免密登录，账号：postgres)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -f /etc/repmgr/17/repmgr.conf standby switchover --remote-user=postgres --always-promote --force-rewind"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("如果最后一步调用repmgr standby switchover一直报错，可以采用手动切换。需要切换node1、node2机器分别执行不同的命令：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1（在node2上执行）停止node2服务")]),s._v("\nsystemctl stop postgresql-17\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2（在node1上执行）node1 promote成主节点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -f /etc/repmgr/17/repmgr.conf standby promote"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3.（在node2上执行）重新加入集群, 成为从节点。如果失败 就只能执行3.1、3.2、3.3进行全拷贝了")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"/usr/pgsql-17/bin/repmgr -f /etc/repmgr/17/repmgr.conf node rejoin -d 'host=192.168.211.2 port=54321 user=repmgr dbname=repmgr' --force-rewind\"")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3.1（在node2上执行）执行拷贝")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -h 192.168.211.1 -p 54321 -U repmgr -d repmgr -f /etc/repmgr/17/repmgr.conf standby clone --force"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3.2（在node2上执行）开启node2服务")]),s._v("\nsystemctl start postgresql-17\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3.3（在node2上执行）重新注册node2为从节点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres -c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/pgsql-17/bin/repmgr -f /etc/repmgr/17/repmgr.conf standby register --force"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("keepalived优先级恢复")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# （在node2上执行）keepalived优先级调低")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/keepalived/keepalived.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     priority 90")]),s._v("\nsystemctl restart keepalived\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h2",{attrs:{id:"五-中文分词器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#五-中文分词器"}},[s._v("#")]),s._v(" 五. 中文分词器")]),s._v(" "),t("p",[s._v("使用pg17安装了两款主流的中文分词器插件pg_jieba和zhparser，")]),s._v(" "),t("p",[s._v("目前发现pg_jieba中文分词无法成功分词，调用返回全是空的。所以最后还是采用zhparser作为主要使用插件。")]),s._v(" "),t("h3",{attrs:{id:"_5-1-zhparser安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-zhparser安装"}},[s._v("#")]),s._v(" 5.1 zhparser安装")]),s._v(" "),t("p",[s._v("github地址：https://github.com/amutu/zhparser")]),s._v(" "),t("p",[s._v("安装scws-1.2.3")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("下载 http://www.xunsearch.com/scws/down/scws-1.2.3.tar.bz2\nyum -y "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bzip2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" -jxvf scws-1.2.3.tar.bz2 scws-1.2.3\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" scws-1.2.3\n./configure\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("安装zhparser")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("下载 https://codeload.github.com/amutu/zhparser/tar.gz/refs/tags/v2.3\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf zhparser-2.3.tar.gz zhparser-2.3\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" zhparser-2.3\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PG_CONFIG")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/pgsql-17/bin/pg_config "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PG_CONFIG")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/pgsql-17/bin/pg_config "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h4",{attrs:{id:"_5-1-1-安装postgresql17-devel"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-1-安装postgresql17-devel"}},[s._v("#")]),s._v(" 5.1.1 安装postgresql17-devel")]),s._v(" "),t("p",[s._v("如果没安装postgresql17-devel包，需要装一下，因为要用到相关的库和头文件。")]),s._v(" "),t("p",[s._v("以redhat8为例")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 手动下载 perl-IPC-Run-0.99-1.el8.noarch.rpm、perl-IO-Tty-1.12-11.el8.x86_64.rpm")]),s._v("\ndnf "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" perl-IPC-Run-0.99-1.el8.noarch.rpm perl-IO-Tty-1.12-11.el8.x86_64.rpm\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 手动下载 postgresql17-devel-17.2-1PGDG.rhel8.x86_64.rpm")]),s._v("\ndnf "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" postgresql17-devel-17.2-1PGDG.rhel8.x86_64.rpm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"_5-2-zhparser使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-zhparser使用"}},[s._v("#")]),s._v(" 5.2 zhparser使用")]),s._v(" "),t("p",[s._v("创建扩展")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("\\c aihub"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" EXTENSION zhparser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TEXT")]),s._v(" SEARCH CONFIGURATION chinese_zhparser "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("PARSER "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" zhparser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 添加名词（n）、动词（v）、形容词（a）、成语（i）、叹词（e）、习用语（l）、副词(d)这6种分词策略")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TEXT")]),s._v(" SEARCH CONFIGURATION chinese_zhparser "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ADD")]),s._v(" MAPPING "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("v"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("l"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("d "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("simple")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- drop TEXT SEARCH CONFIGURATION chinese_zhparser")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("查看扩展插件相关的sql")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" pg_ts_config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" pg_ts_config_map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" pg_ts_parser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" pg_ts_dict"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h4",{attrs:{id:"_5-2-1-词性与相关配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-1-词性与相关配置"}},[s._v("#")]),s._v(" 5.2.1 词性与相关配置")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TEXT")]),s._v(" SEARCH CONFIGURATION chinese_zhparser "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ADD")]),s._v(" MAPPING "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("f"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("g"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("j"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("k"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("l"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("o"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("p"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("r"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("u"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("v"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("w"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("y"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("z "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("simple")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 重建索引")]),s._v("\nREINDEX "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INDEX")]),s._v(" idx_content"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("97")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"adjective,        形容词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("98")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"differentiation,  区别词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("99")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"conjunction,      连词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"adverb,           副词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("101")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"exclamation,      感叹词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("102")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" f"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"position,         方位词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("103")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" g"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root,             词根"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("104")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"head,             前连接成分"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("105")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"idiom,            成语"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("106")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" j"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"abbreviation,     简称"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("107")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" k"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tail,             后连接成分"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("108")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" l"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp,              习用语"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("109")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"numeral,          数词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("110")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"noun,             名词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("111")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" o"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"onomatopoeia,     拟声词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("112")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" p"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"prepositional,    介词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("113")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"quantity,         量词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("114")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" r"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pronoun,          代词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("115")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"space,            处所词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("116")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"time,             时语素"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("117")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" u"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"auxiliary,        助词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("118")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" v"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"verb,             动词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("119")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" w"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"punctuation,      标点符号"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("120")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"unknown,          未知词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("121")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" y"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"modal,            语气词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("122")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" z"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status,           状态词"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("p",[s._v("上述的a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z 均对应了一种词性。debug一下看看：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" ts_parse"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zhparser'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'这种将安全高效整合进研发和运维流程中的安全构建方式'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n tokid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  token\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-------+----------")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("114")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 这种\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 将\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("110")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 安全高效\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("118")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 整\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("110")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 合进\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("106")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 研发\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("99")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 和\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("118")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 运\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("113")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 维\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("110")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 流程\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("102")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 中\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("117")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 的\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("97")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 安全\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("118")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 构建\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("110")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" 方式\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 或者")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" ts_debug"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'chinese_zhparser'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'这种将安全高效整合进研发和运维流程中的安全构建方式'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])]),t("p",[s._v("此时 zhparser 会拆分出 "),t("code",[s._v("安全高效")]),s._v(" 和 "),t("code",[s._v("安全")]),s._v(" 这两个词，并没有拆分出我们所需要的 "),t("code",[s._v("高效")]),s._v(" 关键词。")]),s._v(" "),t("p",[s._v("zhparser 有以下配置，且所有配置默认值均为 false。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("zhparser.punctuation_ignore = f #忽略所有的标点等特殊符号: \nzhparser.seg_with_duality = f #闲散文字自动以二字分词法聚合: \nzhparser.dict_in_memory = f #将词典全部加载到内存里: \nzhparser.multi_short = f #短词复合: \nzhparser.multi_duality = f #散字二元复合: \nzhparser.multi_zmain = f #重要单字复合: \nzhparser.multi_zall = f #全部单字复合: \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("因为 zhparser 插件是一个基于 "),t("a",{attrs:{href:"https://github.com/hightman/scws",target:"_blank",rel:"noopener noreferrer"}},[s._v("SCWS"),t("OutboundLink")],1),s._v(" 能力开发的 PG 中文分词插件。所以我们可以去 "),t("a",{attrs:{href:"http://www.xunsearch.com/scws/demo/v48.php",target:"_blank",rel:"noopener noreferrer"}},[s._v("SCWS 在线测试平台"),t("OutboundLink")],1),s._v(" 根据需要做一些调整。最终我们决定将"),t("code",[s._v("短词复合")]),s._v("配置打开："),t("code",[s._v("zhparser.multi_short = true")]),s._v("添加到 "),t("code",[s._v("postgresql.conf")]),s._v(" 文件中")]),s._v(" "),t("h4",{attrs:{id:"_5-2-2-自定义词库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-2-自定义词库"}},[s._v("#")]),s._v(" 5.2.2 自定义词库")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 添加自定义词")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" zhparser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhprs_custom_word "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'资金压力'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 自定义词库也支持停止词功能，例如我们不希望词语'这是'单独作为一个分词，同样可以在自定义词库中插入对应的词语和控制符停止特定分词：")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" zhparser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhprs_custom_word"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("word"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" attr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'这是'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'!'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 添加/删除自定义分词之后需要执行以下命令才能使词库生效")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" sync_zhprs_custom_word"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查询已存在的自定义词库")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" zhparser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("zhprs_custom_word"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h3",{attrs:{id:"_5-3-中文全文检索"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-中文全文检索"}},[s._v("#")]),s._v(" 5.3 中文全文检索")]),s._v(" "),t("p",[s._v("利用zhparser创建全文索引")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("exists")]),s._v(" fulltext"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    id               "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("36")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("key")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    content          "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("text")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" idx_content "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" message_fulltext "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("using")]),s._v(" gin "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("to_tsvector"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'chinese_zhparser'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" content"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h2",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),t("ol",[t("li",[t("a",{attrs:{href:"https://www.repmgr.org/docs/5.5/index.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("repmgr 5.5.0 Documentation"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://www.postgresql.org/docs/17/index.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("PostgreSQL 17.2 Documentation"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://www.modb.pro/db/1863847640195149824",target:"_blank",rel:"noopener noreferrer"}},[s._v("PostgreSQL 17 增量备份"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=e.exports}}]);